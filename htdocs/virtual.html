<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
	<meta name="author" content="Lukas Castillo, Alec Reyes">
	<meta name="keywords" content="Rubik's Cube, Cubing, Speedcubing">
  <meta name="description" content="A beginners guide to solving a Rubik's Cube">
	<meta name="revised" content="27-10-2022">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Virual Cube - SimplyCube</title>

  <link rel="icon" type="image/gif" href="../images/logo.png">
  <link rel="stylesheet" type="text/css" href="../css/main.css">

  <style>
    #content{
      display: flex;
    }
    #solve-container{
      background-color: rgb(245, 245, 245);
      text-align: center;
      margin: auto;
      color: black;
      width: 100%;
      font-size: 25px;
      border-radius: 7px;
      overflow: auto;
      box-shadow: 5px 5px 5px lightgrey;
      padding: 5%;
    }
    #solve-container > h4{
      margin: 0.2em;
      font-family: 'Rubik', sans-serif;
    }
    #scramble-input{
      width: 100%;
      margin: 0;
      min-height: 1em;
      font-size: 0.5em;
      border: 2px solid black;
      box-sizing: border-box;
    }
    #solve-input{
      width: 100%;
      min-height: 4em;
      max-height: 8em;
      overflow: auto;
      background-color: field;
      padding: 1px 2px;
      border: 2px solid black;
      cursor: text;
      box-sizing: border-box;
      display: inline-block;
      font-size: 0.5em;
      text-align: left;
    }
    #play-button{
      background-image: url("../images/play-button.svg");
      background-size: cover;
      height: 55px;
      width: 55px;
      padding: 0;
      border: none;
      margin: 5px;
    }
    #play-button:hover {
      background-color: lightgray;
    }
  </style>
</head>

<body>
  <!--Header-->
  <header>
    <a href="../">
      <img id="home-button" width=30 height=30 src="../images/logo.png"></img>
    </a>
    <p>SimplyCube</p>
    <button id="menu-button">Menu</button>
    <ul id="nav-buttons">
      <li>
        <p>Beginner</p>
        <div class="nav-dropdown-content">
          <a href="../htdocs/beginner.html">Beginner Tutorial</a>
          <a href="../htdocs/notation.html">Notation</a>
        </div>
      </li>
      <li>
        <p>Advanced</p>
        <div class="nav-dropdown-content">
          <a href="../htdocs/cfop.html">CFOP Tutorial</a>
          <a href="../htdocs/pll.html">PLL</a>
          <a href="../htdocs/oll.html">OLL</a>
        </div>
      </li>
      <li>
        <p>Practice</p>
        <div class="nav-dropdown-content">
          <a href="../htdocs/timer.html">Timer</a>
          <a href="../htdocs/virtual.html">Virtual Cube</a>
        </div>
      </li>
    </ul>
  </header>

  <div id="content">
    <!--The canvas that renders the cube-->
    <canvas width="400px" height="400px" id="c"></canvas>
    <!--the solve container-->
    <div id="solve-container">
      <h4>Scramble</h4>
      <input type="text" id="scramble-input">
      <h4>Solve</h4>
      <div id="solve-input" contenteditable="true">
        <span></span>
      </div>
      <button id="play-button"></button>
    </div>
  </div>
  <label>Moves</label><br>
  <input type="text" id="text"><br>
  <button id="button">Enter</button><br>
  <button id="toggle">Enable controls</button><br>
  <button id="clear">Reset</button>

  <!--Footer-->
  <footer>
    <div>
      <h2>Contact Us:</h2>
      b2026slccastillo@pshs.edu.ph <br>
      b2026andreyes@pshs.edu.ph
    </div>
    <div>
      <h2>Copyright &copy; 2022</h2>
    </div>
    <div>
      <h2>Other Links:</h2>
      <a href="https://github.com/Alec-Reyes/MgReyesCastillio"> Github </a> <br>
      <a href="htdocs/sources.html"> Sources </a>
    </div>
  </footer>

  <script type="module">
    import {Cube, Camera, rotateCameraByMouse, convertMoves} from "../js/cube.js"
    var camera = {};
    var cube = {};
    //milliseconds per frame
    const MPF = 10;
    //turns per second
    const TPS = 3;

    let toggled = false;

    function setTurns() {
      let value = document.getElementById("text").value;
      let moves = convertMoves(value);
      if(moves == null){

      }else{
        cube.instantComplete();
        cube.setTurns(moves);
      }
    }

    function toggleControls() {
      let button = document.getElementById("toggle");

      toggled = !toggled;
      if (toggled) button.innerHTML = "Disable Controls";
      else button.innerHTML = "Enable Controls";
    }

    if(!window.toload) window.toload = [];
    window.toload.push(function () {
      let canvas = document.getElementById("c");

      camera = new Camera(4, 4, 0, 135, 0, 0, 80, 400, 400, 45, 30);
      camera.lookAtOrigin();

      cube = new Cube("");
      cube.draw(canvas, camera, TPS);

      document.getElementById("button").onclick = function () {setTurns()};
      document.getElementById("toggle").onclick = function () {toggleControls()};
      document.getElementById("clear").onclick = function() {cube.clear([])};
      canvas.onmousemove = function(e){rotateCameraByMouse(camera, [4, 4, 0], e)};

      setInterval(() => {
        //camera.rotArPoint(0, 1, 0, [0, 0, 0]);
        camera.lookAtOrigin();
        cube.draw(canvas, camera, TPS);
        //console.log(camera.pitch);
      }, MPF);

      //event listener for the solve input
      let solveInput = document.getElementById("solve-input");

      solveInput.onkeyup = function(e) {
        const moveSym = ["U", "D", "R", "L", "F", "B", "M", "E", "S", "u", "d", "r", "l", "f", "b", "Uw", "Dw", "Rw", "Lw", "Fw", "Bw", "x", "y", "z"];
        const remove = [" ", "(", ")", "[", "]", ","];
        let moves = "";
        let result = [];

        moves = solveInput.innerHTML;

        moves = moves.replaceAll("&nbsp;", " ");
        moves = moves.replaceAll("<br>", "\n");
        if(!moves.endsWith("\n")) moves += "\n";

        let newMoves = "";
        let canceled = false;
        for(let i = 0; i < moves.length; i++){
          if(moves.charAt(i) == "<") canceled = true;
          if(!canceled) newMoves += moves.charAt(i);
          if(moves.charAt(i) == ">") canceled = false;
        }

        moves = newMoves;

        console.log(moves);

        let current = "";
        let index = moves.indexOf("//");
        while(index != -1){
          result.push(moves.slice(0, index));
          moves = moves.slice(index);
          index = moves.indexOf("\n");
          result.push(moves.slice(0, index + 1));
          moves = moves.slice(index + 1);
          index = moves.indexOf("//");
          console.log(moves);
        }
        if(moves.length > 0) result.push(moves);

        console.log(result);

        remove.forEach((c) => {moves = moves.replaceAll(c, "")});

        //console.log("Pruned: " + moves);

        while(moves.length > 0){
          let m = null;
          moveSym.some(move => {
            if(moves.startsWith(move))
              m = move;
            return m != null;
          });
          if(m == null) return null;
          else{
            result.push(moves.substring(0, m.length));
            moves = moves.slice(m.length);
            if(moves.startsWith("'") || moves.startsWith("2")){
              result[result.length - 1] += moves.charAt(0);
              moves = moves.slice(1);
            }
          }
        }
      };
    });

    if(!window.tokeydown) window.tokeydown = [];
    window.tokeydown.push(function (e) {
      const step = 0.5;

      if (!toggled) return;
      if (e.code == "KeyA") camera.x -= step;
      else if (e.code == "KeyD") camera.x += step;
      else if (e.code == "KeyW") camera.y -= step;
      else if (e.code == "KeyS") camera.y += step;
      else if (e.code == "KeyR") camera.z -= step;
      else if (e.code == "KeyT") camera.z += step;
      else if (e.code == "KeyZ") camera.yaw -= step;
      else if (e.code == "KeyX") camera.yaw += step;
      else if (e.code == "KeyC") camera.pitch -= step;
      else if (e.code == "KeyV") camera.pitch += step;
      else if (e.code == "KeyB") camera.fov -= step;
      else if (e.code == "KeyN") camera.fov += step;
      else return;

      if (camera.yaw < 0) camera.yaw = 360;
      if (camera.pitch < 0) camera.pitch = 360;
      if (camera.roll < 0) camera.roll = 360;

      //let t = new Date().getTime();
      //cube.draw(document.getElementById("c"), camera, TPS);

      console.log("x: " + camera.x + " y: " + camera.y + " z: " + camera.z);
      console.log("yaw: " + camera.yaw + " pitch: " + camera.pitch);
      console.log("fov: " + camera.fov);
      //console.log("Time Elapsed: " + (new Date().getTime() - t));
    });
  </script>
  <script src="../js/script.js"></script>
</body>

</html>
