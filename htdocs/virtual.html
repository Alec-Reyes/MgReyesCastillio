<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
	<meta name="author" content="Lukas Castillo, Alec Reyes">
	<meta name="keywords" content="Rubik's Cube, Cubing, Speedcubing">
  <meta name="description" content="A beginners guide to solving a Rubik's Cube">
	<meta name="revised" content="27-10-2022">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Virual Cube - SimplyCube</title>

  <link rel="icon" type="image/gif" href="../images/logo.png">
  <link rel="stylesheet" type="text/css" href="../css/main.css">

  <style>
    #content{
      display: flex;
    }
    #solve-container{
      background-color: rgb(245, 245, 245);
      text-align: center;
      margin: auto;
      color: black;
      width: 100%;
      font-size: 25px;
      border-radius: 7px;
      overflow: auto;
      box-shadow: 5px 5px 5px lightgrey;
      padding: 5%;
    }
    #solve-container > h4{
      margin: 0.2em;
      font-family: 'Rubik', sans-serif;
    }
    #scramble-input{
      width: 100%;
      margin: 0;
      min-height: 1em;
      font-size: 0.5em;
      border: 2px solid black;
      box-sizing: border-box;
    }
    #solve-input, #clear-solve-input{
      width: 100%;
      min-height: 4em;
      max-height: 8em;
      overflow: auto;
      background-color: field;
      padding: 1px 2px;
      border: 2px solid black;
      cursor: text;
      box-sizing: border-box;
      display: block;
      font-size: 0.5em;
      text-align: left;
      font-family: Courier;
    }
    #clear-solve-input{
      background-color: transparent;
      color: transparent;
      caret-color: black;
      border-color: transparent;
    }
    #solve-input .comment{
      color: green;
    }
    #solve-input .error{
      text-decoration: underline;
      text-decoration-color: red;
    }
    #play-button{
      background-image: url("../images/play-button.svg");
      background-size: cover;
      height: 55px;
      width: 55px;
      padding: 0;
      border: none;
      margin: 5px;
    }
    #play-button:hover {
      background-color: lightgray;
    }
  </style>
</head>

<body>
  <!--Header-->
  <header>
    <a href="../">
      <img id="home-button" width=30 height=30 src="../images/logo.png"></img>
    </a>
    <p>SimplyCube</p>
    <button id="menu-button">Menu</button>
    <ul id="nav-buttons">
      <li>
        <p>Beginner</p>
        <div class="nav-dropdown-content">
          <a href="../htdocs/beginner.html">Beginner Tutorial</a>
          <a href="../htdocs/notation.html">Notation</a>
        </div>
      </li>
      <li>
        <p>Advanced</p>
        <div class="nav-dropdown-content">
          <a href="../htdocs/cfop.html">CFOP Tutorial</a>
          <a href="../htdocs/pll.html">PLL</a>
          <a href="../htdocs/oll.html">OLL</a>
        </div>
      </li>
      <li>
        <p>Practice</p>
        <div class="nav-dropdown-content">
          <a href="../htdocs/timer.html">Timer</a>
          <a href="../htdocs/virtual.html">Virtual Cube</a>
        </div>
      </li>
    </ul>
  </header>

  <div id="content">
    <!--The canvas that renders the cube-->
    <canvas width="400px" height="400px" id="c"></canvas>
    <!--the solve container-->
    <div id="solve-container">
      <h4>Scramble</h4>
      <input type="text" id="scramble-input" spellcheck="false">
      <h4>Solve</h4>
      <div id="solve-input" style="white-space: pre-line" spellcheck="false"></div>
      <div id="clear-solve-input" contenteditable="true" spellcheck="false"></div>
      <button id="play-button"></button>
    </div>
  </div>
  <label>Moves</label><br>
  <input type="text" id="text"><br>
  <button id="button">Enter</button><br>
  <button id="toggle">Enable controls</button><br>
  <button id="clear">Reset</button>

  <!--Footer-->
  <footer>
    <div>
      <h2>Contact Us:</h2>
      b2026slccastillo@pshs.edu.ph <br>
      b2026andreyes@pshs.edu.ph
    </div>
    <div>
      <h2>Copyright &copy; 2022</h2>
    </div>
    <div>
      <h2>Other Links:</h2>
      <a href="https://github.com/Alec-Reyes/MgReyesCastillio"> Github </a> <br>
      <a href="htdocs/sources.html"> Sources </a>
    </div>
  </footer>

  <script>
    function run(s){
      document.getElementById("solve-input").innerHTML = s;
    }
  </script>

  <script type="module">
    import {Cube, Camera, rotateCameraByMouse, convertMoves} from "../js/cube.js"
    var camera = {};
    var cube = {};
    var currentSolve = [];
    //milliseconds per frame
    const MPF = 10;
    //turns per second
    const TPS = 3;

    let toggled = false;

    function setTurns() {
      let value = document.getElementById("text").value;
      let moves = convertMoves(value);
      if(moves == null){

      }else{
        cube.instantComplete();
        cube.setTurns(moves);
      }
    }

    function toggleControls() {
      let button = document.getElementById("toggle");

      toggled = !toggled;
      if (toggled) button.innerHTML = "Disable Controls";
      else button.innerHTML = "Enable Controls";
    }

    function fixSolveInput() {
      let element = document.getElementById("solve-input");
      let rect = element.getBoundingClientRect();
      let clearElement = document.getElementById("clear-solve-input");
      clearElement.style.marginTop = -rect.height + "px";
    }

    function fixScroll(){
      let clearElement = document.getElementById("clear-solve-input");
      let element = document.getElementById("solve-input");
      element.scrollTop = clearElement.scrollTop;
      element.scrollLeft = clearElement.scrollLeft;
      //console.log("fixing");
    }

    if(!window.toload) window.toload = [];
    window.toload.push(function () {
      let canvas = document.getElementById("c");

      camera = new Camera(4, 4, 0, 135, 0, 0, 80, 400, 400, 45, 30);
      camera.lookAtOrigin();

      cube = new Cube("");
      cube.draw(canvas, camera, TPS);

      document.getElementById("button").onclick = function () {setTurns()};
      document.getElementById("toggle").onclick = function () {toggleControls()};
      document.getElementById("clear").onclick = function() {cube.clear([])};
      canvas.onmousemove = function(e){rotateCameraByMouse(camera, [4, 4, 0], e)};

      setInterval(() => {
        //camera.rotArPoint(0, 1, 0, [0, 0, 0]);
        camera.lookAtOrigin();
        cube.draw(canvas, camera, TPS);
        //console.log(camera.pitch);
      }, MPF);

      fixSolveInput();
      //event listener for the solve input
      let solveInput = document.getElementById("solve-input");
      let clearSolveInput = document.getElementById("clear-solve-input");

      clearSolveInput.onscroll = function(e) {fixScroll()};
      clearSolveInput.onkeyup = function(e) {
        const moveSym = ["U", "D", "R", "L", "F", "B", "M", "E", "S", "u", "d", "r", "l", "f", "b", "Uw", "Dw", "Rw", "Lw", "Fw", "Bw", "x", "y", "z"];
        const remove = [" ", "(", ")", "[", "]", ",", "\n"];
        let moves = "";
        let result = [];

        moves = clearSolveInput.innerHTML.replaceAll("&nbsp;", " ");

        //adds newlines based on the divs
        let newMoves = "";
        let canceled = false;
        for(let i = 0; i < moves.length; i++){
          if(!canceled && i > 0 && moves.substring(i, i + 5) == "<div>" && moves.substring(i, i + 11) != "<div></div>") newMoves += "\n";
          if(moves.charAt(i) == "<") canceled = true;
          if(!canceled) newMoves += moves.charAt(i);
          if(moves.charAt(i) == ">") canceled = false;
        }

        moves = newMoves;

        //filters comments
        let current = "";
        let index = moves.indexOf("//");
        while(index != -1){
          result.push(moves.slice(0, index));
          moves = moves.slice(index);
          index = moves.indexOf("\n");
          if(index == -1) index = moves.length - 1;
          result.push("<span class=\"comment\">" + moves.slice(0, index + 1) + "</span>");
          moves = moves.slice(index + 1);
          index = moves.indexOf("//");
        }
        if(moves.length > 0) result.push(moves);

        console.log(result);

        //filters temp symbols
        newMoves = [];
        for(let i = 0; i < result.length; i++){
          let line = result[i];
          if(!result[i].startsWith("<span")) {
            //remove.forEach(c => result[i] = result[i].replaceAll(c, "<span class=\"symbol\">" + c + "</span>"));
            while(line.length > 0){
              let index = line.length;
              for(const r of remove){
                let i = line.indexOf(r);
                if(i != -1 && i < index) index = i
              }
              if(index == line.length){
                newMoves.push(line);
                line = "";
              }else{
                if(index > 0) newMoves.push(line.slice(0, index));
                newMoves.push("<span class=\"symbol\">" + line.substring(index, index + 1) + "</span>");
                line = line.slice(index + 1);
              }
            }
          }
          if(line.length > 0) newMoves.push(line);
        }
        result = newMoves;

        //fillter moves
        newMoves = [];
        currentSolve = [];
        for(let i = 0; i < result.length; i++){
          let line = result[i];
          if(!line.startsWith("<span")){
            let r = [];
            while(line.length > 0){
              let m = null;
              moveSym.some(move => {
                if(line.startsWith(move))
                  m = move;
                return m != null;
              });
              if(m == null){
                r.push("<span class=\"error\">" + line.substring(0, 1) + "</span>");
                line = line.slice(1);
              }else{
                let str = line.substring(0, m.length);
                line = line.slice(m.length);
                if(line.startsWith("'") || line.startsWith("2")){
                  str += line.charAt(0);
                  line = line.slice(1);
                }
                r.push("<span class=\"move\">" + str + "</span>");
                currentSolve.push(str);
              }
            }
            line = "";
            for(const str of r) line += str;
          }
          newMoves.push(line);
        }
        result = newMoves;

        console.log("final: " + result);
        console.log(currentSolve);

        //adds all the array elements together
        let final = "";
        result.forEach(s => final += s);
        solveInput.innerHTML = final + "&nbsp;";

        fixScroll();
        fixSolveInput();

        while(moves.length > 0){
          let m = null;
          moveSym.some(move => {
            if(moves.startsWith(move))
              m = move;
            return m != null;
          });
          if(m == null) return null;
          else{
            result.push(moves.substring(0, m.length));
            moves = moves.slice(m.length);
            if(moves.startsWith("'") || moves.startsWith("2")){
              result[result.length - 1] += moves.charAt(0);
              moves = moves.slice(1);
            }
          }
        }
      };
    });

    if(!window.tokeydown) window.tokeydown = [];
    window.tokeydown.push(function (e) {
      const step = 0.5;

      if (!toggled) return;
      if (e.code == "KeyA") camera.x -= step;
      else if (e.code == "KeyD") camera.x += step;
      else if (e.code == "KeyW") camera.y -= step;
      else if (e.code == "KeyS") camera.y += step;
      else if (e.code == "KeyR") camera.z -= step;
      else if (e.code == "KeyT") camera.z += step;
      else if (e.code == "KeyZ") camera.yaw -= step;
      else if (e.code == "KeyX") camera.yaw += step;
      else if (e.code == "KeyC") camera.pitch -= step;
      else if (e.code == "KeyV") camera.pitch += step;
      else if (e.code == "KeyB") camera.fov -= step;
      else if (e.code == "KeyN") camera.fov += step;
      else return;

      if (camera.yaw < 0) camera.yaw = 360;
      if (camera.pitch < 0) camera.pitch = 360;
      if (camera.roll < 0) camera.roll = 360;

      //let t = new Date().getTime();
      //cube.draw(document.getElementById("c"), camera, TPS);

      console.log("x: " + camera.x + " y: " + camera.y + " z: " + camera.z);
      console.log("yaw: " + camera.yaw + " pitch: " + camera.pitch);
      console.log("fov: " + camera.fov);
      //console.log("Time Elapsed: " + (new Date().getTime() - t));
    });
  </script>
  <script src="../js/script.js"></script>
</body>

</html>
